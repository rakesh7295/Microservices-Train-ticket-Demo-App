<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RebookServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ts-rebook-service</a> &gt; <a href="index.source.html" class="el_package">rebook.service</a> &gt; <span class="el_source">RebookServiceImpl.java</span></div><h1>RebookServiceImpl.java</h1><pre class="source lang-java linenums">package rebook.service;

import edu.fudan.common.util.Response;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import rebook.entity.*;
import rebook.entity.RebookInfo;

import java.math.BigDecimal;
import java.util.Calendar;
import java.util.Date;

/**
 * @author fdse
 */
@Service
<span class="fc" id="L23">public class RebookServiceImpl implements RebookService {</span>

    @Autowired
    private RestTemplate restTemplate;

    @Override
    public Response rebook(RebookInfo info, HttpHeaders httpHeaders) {

<span class="fc" id="L31">        Response&lt;Order&gt; queryOrderResult = getOrderByRebookInfo(info, httpHeaders);</span>

<span class="pc bpc" id="L33" title="1 of 2 branches missed.">        if (queryOrderResult.getStatus() == 1) {</span>
<span class="pc bpc" id="L34" title="1 of 2 branches missed.">            if (queryOrderResult.getData().getStatus() != 1) {</span>
<span class="nc" id="L35">                return new Response&lt;&gt;(0, &quot;you order not suitable to rebook!&quot;, null);</span>
            }
        } else {
<span class="nc" id="L38">            return new Response(0, &quot;order not found&quot;, null);</span>
        }

<span class="fc" id="L41">        Order order = queryOrderResult.getData();</span>
<span class="fc" id="L42">        int status = order.getStatus();</span>
<span class="pc bpc" id="L43" title="1 of 2 branches missed.">        if (status == OrderStatus.NOTPAID.getCode()) {</span>
<span class="nc" id="L44">            return new Response&lt;&gt;(0, &quot;You haven't paid the original ticket!&quot;, null);</span>
<span class="pc bpc" id="L45" title="1 of 2 branches missed.">        } else if (status == OrderStatus.PAID.getCode()) {</span>
            // do nothing
<span class="nc bnc" id="L47" title="All 2 branches missed.">        } else if (status == OrderStatus.CHANGE.getCode()) {</span>
<span class="nc" id="L48">            return new Response&lt;&gt;(0, &quot;You have already changed your ticket and you can only change one time.&quot;, null);</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">        } else if (status == OrderStatus.COLLECTED.getCode()) {</span>
<span class="nc" id="L50">            return new Response&lt;&gt;(0, &quot;You have already collected your ticket and you can change it now.&quot;, null);</span>
        } else {
<span class="nc" id="L52">            return new Response&lt;&gt;(0, &quot;You can't change your ticket.&quot;, null);</span>
        }

        //Check the current time and the bus time of the old order, and judge whether the ticket can be changed according to the time. The ticket cannot be changed after two hours.
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">        if (!checkTime(order.getTravelDate(), order.getTravelTime())) {</span>
<span class="nc" id="L57">            return new Response&lt;&gt;(0, &quot;You can only change the ticket before the train start or within 2 hours after the train start.&quot;, null);</span>
        }

        //The departure and destination cannot be changed, only the train number, seat and time can be changed
        //Check the info of seat availability and trains
<span class="fc" id="L62">        TripAllDetailInfo gtdi = new TripAllDetailInfo();</span>
<span class="fc" id="L63">        gtdi.setFrom(queryForStationName(order.getFrom(), httpHeaders));</span>
<span class="fc" id="L64">        gtdi.setTo(queryForStationName(order.getTo(), httpHeaders));</span>
<span class="fc" id="L65">        gtdi.setTravelDate(info.getDate());</span>
<span class="fc" id="L66">        gtdi.setTripId(info.getTripId());</span>
<span class="fc" id="L67">        Response&lt;TripAllDetail&gt; gtdr = getTripAllDetailInformation(gtdi, info.getTripId(), httpHeaders);</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">        if (gtdr.getStatus() == 0) {</span>
<span class="nc" id="L69">            return new Response&lt;&gt;(0, gtdr.getMsg(), null);</span>
        } else {
<span class="fc" id="L71">            TripResponse tripResponse = gtdr.getData().getTripResponse();</span>
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">            if (info.getSeatType() == SeatClass.FIRSTCLASS.getCode()) {</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">                if (tripResponse.getConfortClass() &lt;= 0) {</span>
<span class="nc" id="L74">                    return new Response&lt;&gt;(0, &quot;Seat Not Enough&quot;, null);</span>
                }
            } else {
<span class="nc bnc" id="L77" title="All 4 branches missed.">                if (tripResponse.getEconomyClass() == SeatClass.SECONDCLASS.getCode() &amp;&amp; tripResponse.getConfortClass() &lt;= 0) {</span>
<span class="nc" id="L78">                    return new Response&lt;&gt;(0, &quot;Seat Not Enough&quot;, null);</span>
                }
            }
        }

        //Deal with the difference, more refund less compensation
        //Return the original ticket so that someone else can book the corresponding seat

<span class="fc" id="L86">        String ticketPrice = &quot;0&quot;;</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        if (info.getSeatType() == SeatClass.FIRSTCLASS.getCode()) {</span>
<span class="fc" id="L88">            ticketPrice = ((TripAllDetail) gtdr.getData()).getTripResponse().getPriceForConfortClass();</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        } else if (info.getSeatType() == SeatClass.SECONDCLASS.getCode()) {</span>
<span class="nc" id="L90">            ticketPrice = ((TripAllDetail) gtdr.getData()).getTripResponse().getPriceForEconomyClass();</span>
        }
<span class="fc" id="L92">        String oldPrice = order.getPrice();</span>
<span class="fc" id="L93">        BigDecimal priceOld = new BigDecimal(oldPrice);</span>
<span class="fc" id="L94">        BigDecimal priceNew = new BigDecimal(ticketPrice);</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">        if (priceOld.compareTo(priceNew) &gt; 0) {</span>
            //Refund the difference
<span class="nc" id="L97">            String difference = priceOld.subtract(priceNew).toString();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            if (!drawBackMoney(info.getLoginId(), difference, httpHeaders)) {</span>
<span class="nc" id="L99">                return new Response&lt;&gt;(0, &quot;Can't draw back the difference money, please try again!&quot;, null);</span>
            }
<span class="nc" id="L101">            return updateOrder(order, info, (TripAllDetail) gtdr.getData(), ticketPrice, httpHeaders);</span>

<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        } else if (priceOld.compareTo(priceNew) == 0) {</span>
            //do nothing
<span class="nc" id="L105">            return updateOrder(order, info, (TripAllDetail) gtdr.getData(), ticketPrice, httpHeaders);</span>
        } else {
            //make up the difference
<span class="fc" id="L108">            String difference = priceNew.subtract(priceOld).toString();</span>
<span class="fc" id="L109">            Order orderMoneyDifference = new Order();</span>
<span class="fc" id="L110">            orderMoneyDifference.setDifferenceMoney(difference);</span>
<span class="fc" id="L111">            return new Response&lt;&gt;(2, &quot;Please pay the different money!&quot;, orderMoneyDifference);</span>
        }
    }

    @Override
    public Response payDifference(RebookInfo info, HttpHeaders httpHeaders) {

<span class="fc" id="L118">        Response queryOrderResult = getOrderByRebookInfo(info, httpHeaders);</span>

<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (queryOrderResult.getStatus() == 0) {</span>
<span class="nc" id="L121">            return new Response&lt;&gt;(0, queryOrderResult.getMsg(), null);</span>
        }
<span class="fc" id="L123">        Order order = (Order) queryOrderResult.getData();</span>

<span class="fc" id="L125">        TripAllDetailInfo gtdi = new TripAllDetailInfo();</span>
<span class="fc" id="L126">        gtdi.setFrom(queryForStationName(order.getFrom(), httpHeaders));</span>
<span class="fc" id="L127">        gtdi.setTo(queryForStationName(order.getTo(), httpHeaders));</span>
<span class="fc" id="L128">        gtdi.setTravelDate(info.getDate());</span>
<span class="fc" id="L129">        gtdi.setTripId(info.getTripId());</span>
        // TripAllDetail
<span class="fc" id="L131">        Response gtdrResposne = getTripAllDetailInformation(gtdi, info.getTripId(), httpHeaders);</span>
<span class="fc" id="L132">        TripAllDetail gtdr = (TripAllDetail) gtdrResposne.getData();</span>

<span class="fc" id="L134">        String ticketPrice = &quot;0&quot;;</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">        if (info.getSeatType() == SeatClass.FIRSTCLASS.getCode()) {</span>
<span class="nc" id="L136">            ticketPrice = gtdr.getTripResponse().getPriceForConfortClass();</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        } else if (info.getSeatType() == SeatClass.SECONDCLASS.getCode()) {</span>
<span class="nc" id="L138">            ticketPrice = gtdr.getTripResponse().getPriceForEconomyClass();</span>
        }
<span class="fc" id="L140">        String oldPrice = order.getPrice();</span>
<span class="fc" id="L141">        BigDecimal priceOld = new BigDecimal(oldPrice);</span>
<span class="fc" id="L142">        BigDecimal priceNew = new BigDecimal(ticketPrice);</span>

<span class="pc bpc" id="L144" title="1 of 2 branches missed.">        if (payDifferentMoney(info.getOrderId(), info.getTripId(), info.getLoginId(), priceNew.subtract(priceOld).toString(), httpHeaders)) {</span>
<span class="nc" id="L145">            return updateOrder(order, info, gtdr, ticketPrice, httpHeaders);</span>
        } else {
<span class="fc" id="L147">            return new Response&lt;&gt;(0, &quot;Can't pay the difference,please try again&quot;, null);</span>
        }
    }

    private Response updateOrder(Order order, RebookInfo info, TripAllDetail gtdr, String ticketPrice, HttpHeaders httpHeaders) {

        //4.Modify the original order and set the information of the order
<span class="nc" id="L154">        Trip trip = gtdr.getTrip();</span>
<span class="nc" id="L155">        String oldTripId = order.getTrainNumber();</span>
<span class="nc" id="L156">        order.setTrainNumber(info.getTripId());</span>
<span class="nc" id="L157">        order.setBoughtDate(new Date());</span>
<span class="nc" id="L158">        order.setStatus(OrderStatus.CHANGE.getCode());</span>
<span class="nc" id="L159">        order.setPrice(ticketPrice);//Set ticket price</span>
<span class="nc" id="L160">        order.setSeatClass(info.getSeatType());</span>
<span class="nc" id="L161">        order.setTravelDate(info.getDate());</span>
<span class="nc" id="L162">        order.setTravelTime(trip.getStartingTime());</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (info.getSeatType() == SeatClass.FIRSTCLASS.getCode()) {//Dispatch the seat</span>
<span class="nc" id="L165">            Ticket ticket =</span>
<span class="nc" id="L166">                    dipatchSeat(info.getDate(),</span>
<span class="nc" id="L167">                            order.getTrainNumber(), order.getFrom(), order.getTo(),</span>
<span class="nc" id="L168">                            SeatClass.FIRSTCLASS.getCode(), httpHeaders);</span>
<span class="nc" id="L169">            order.setSeatClass(SeatClass.FIRSTCLASS.getCode());</span>
<span class="nc" id="L170">            order.setSeatNumber(&quot;&quot; + ticket.getSeatNo());</span>
<span class="nc" id="L171">        } else {</span>
<span class="nc" id="L172">            Ticket ticket =</span>
<span class="nc" id="L173">                    dipatchSeat(info.getDate(),</span>
<span class="nc" id="L174">                            order.getTrainNumber(), order.getFrom(), order.getTo(),</span>
<span class="nc" id="L175">                            SeatClass.SECONDCLASS.getCode(), httpHeaders);</span>
<span class="nc" id="L176">            order.setSeatClass(SeatClass.SECONDCLASS.getCode());</span>
<span class="nc" id="L177">            order.setSeatNumber(&quot;&quot; + ticket.getSeatNo());</span>
        }

        //Update order information
        //If the original order and the new order are located in the high-speed train and other orders respectively, the original order should be deleted and created on the other side with a new id.
<span class="nc bnc" id="L182" title="All 8 branches missed.">        if ((tripGD(oldTripId) &amp;&amp; tripGD(info.getTripId())) || (!tripGD(oldTripId) &amp;&amp; !tripGD(info.getTripId()))) {</span>

<span class="nc" id="L184">            Response changeOrderResult = updateOrder(order, info.getTripId(), httpHeaders);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (changeOrderResult.getStatus() == 1) {</span>
<span class="nc" id="L186">                return new Response&lt;&gt;(1, &quot;Success!&quot;, order);</span>
            } else {
<span class="nc" id="L188">                return new Response&lt;&gt;(0, &quot;Can't update Order!&quot;, null);</span>
            }
        } else {
            //Delete the original order
<span class="nc" id="L192">            deleteOrder(order.getId().toString(), oldTripId, httpHeaders);</span>
            //Create a new order on the other side
<span class="nc" id="L194">            createOrder(order, order.getTrainNumber(), httpHeaders);</span>
<span class="nc" id="L195">            return new Response&lt;&gt;(1, &quot;Success&quot;, order);</span>
        }
    }

    public Ticket dipatchSeat(Date date, String tripId, String startStationId, String endStataionId, int seatType, HttpHeaders httpHeaders) {
<span class="fc" id="L200">        Seat seatRequest = new Seat();</span>
<span class="fc" id="L201">        seatRequest.setTravelDate(date);</span>
<span class="fc" id="L202">        seatRequest.setTrainNumber(tripId);</span>
<span class="fc" id="L203">        seatRequest.setSeatType(seatType);</span>
<span class="fc" id="L204">        seatRequest.setStartStation(startStationId);</span>
<span class="fc" id="L205">        seatRequest.setDestStation(endStataionId);</span>

<span class="fc" id="L207">        HttpEntity requestEntityTicket = new HttpEntity(seatRequest, httpHeaders);</span>
<span class="fc" id="L208">        ResponseEntity&lt;Response&lt;Ticket&gt;&gt; reTicket = restTemplate.exchange(</span>
                &quot;http://ts-seat-service:18898/api/v1/seatservice/seats&quot;,
                HttpMethod.POST,
                requestEntityTicket,
<span class="fc" id="L212">                new ParameterizedTypeReference&lt;Response&lt;Ticket&gt;&gt;() {</span>
                });
<span class="fc" id="L214">        return reTicket.getBody().getData();</span>
    }


    private boolean tripGD(String tripId) {
<span class="nc bnc" id="L219" title="All 4 branches missed.">        return tripId.startsWith(&quot;G&quot;) || tripId.startsWith(&quot;D&quot;);</span>
    }

    private boolean checkTime(Date travelDate, Date travelTime) {
<span class="fc" id="L223">        boolean result = true;</span>
<span class="fc" id="L224">        Calendar calDateA = Calendar.getInstance();</span>
<span class="fc" id="L225">        Date today = new Date();</span>
<span class="fc" id="L226">        calDateA.setTime(today);</span>
<span class="fc" id="L227">        Calendar calDateB = Calendar.getInstance();</span>
<span class="fc" id="L228">        calDateB.setTime(travelDate);</span>
<span class="fc" id="L229">        Calendar calDateC = Calendar.getInstance();</span>
<span class="fc" id="L230">        calDateC.setTime(travelTime);</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">        if (calDateA.get(Calendar.YEAR) &gt; calDateB.get(Calendar.YEAR)) {</span>
<span class="nc" id="L232">            result = false;</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        } else if (calDateA.get(Calendar.YEAR) == calDateB.get(Calendar.YEAR)) {</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">            if (calDateA.get(Calendar.MONTH) &gt; calDateB.get(Calendar.MONTH)) {</span>
<span class="nc" id="L235">                result = false;</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">            } else if (calDateA.get(Calendar.MONTH) == calDateB.get(Calendar.MONTH)) {</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">                if (calDateA.get(Calendar.DAY_OF_MONTH) &gt; calDateB.get(Calendar.DAY_OF_MONTH)) {</span>
<span class="nc" id="L238">                    result = false;</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">                } else if (calDateA.get(Calendar.DAY_OF_MONTH) == calDateB.get(Calendar.DAY_OF_MONTH)) {</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">                    if (calDateA.get(Calendar.HOUR_OF_DAY) &gt; calDateC.get(Calendar.HOUR_OF_DAY) + 2) {</span>
<span class="nc" id="L241">                        result = false;</span>
<span class="pc bpc" id="L242" title="3 of 4 branches missed.">                    } else if (calDateA.get(Calendar.HOUR_OF_DAY) == (calDateC.get(Calendar.HOUR_OF_DAY) + 2) &amp;&amp; calDateA.get(Calendar.MINUTE) &gt; calDateC.get(Calendar.MINUTE)) {</span>
<span class="nc" id="L243">                        result = false;</span>
                    }
                }
            }
        }
<span class="fc" id="L248">        return result;</span>
    }


    private Response&lt;TripAllDetail&gt; getTripAllDetailInformation(TripAllDetailInfo gtdi, String tripId, HttpHeaders httpHeaders) {
        Response&lt;TripAllDetail&gt; gtdr;
<span class="fc" id="L254">        String requestUrl = &quot;&quot;;</span>
<span class="pc bpc" id="L255" title="1 of 4 branches missed.">        if (tripId.startsWith(&quot;G&quot;) || tripId.startsWith(&quot;D&quot;)) {</span>
<span class="fc" id="L256">            requestUrl = &quot;http://ts-travel-service:12346/api/v1/travelservice/trip_detail&quot;;</span>
            // ts-travel-service:12346/travel/getTripAllDetailInfo
        } else {
<span class="fc" id="L259">            requestUrl = &quot;http://ts-travel2-service:16346/api/v1/travel2service/trip_detail&quot;;</span>
            //ts-travel2-service:16346/travel2/getTripAllDetailInfo
        }
<span class="fc" id="L262">        HttpEntity requestGetTripAllDetailResult = new HttpEntity(gtdi, httpHeaders);</span>
<span class="fc" id="L263">        ResponseEntity&lt;Response&lt;TripAllDetail&gt;&gt; reGetTripAllDetailResult = restTemplate.exchange(</span>
                requestUrl,
                HttpMethod.POST,
                requestGetTripAllDetailResult,
<span class="fc" id="L267">                new ParameterizedTypeReference&lt;Response&lt;TripAllDetail&gt;&gt;() {</span>
                });
<span class="fc" id="L269">        gtdr = reGetTripAllDetailResult.getBody();</span>
<span class="fc" id="L270">        return gtdr;</span>
    }

    private Response createOrder(Order order, String tripId, HttpHeaders httpHeaders) {
<span class="nc" id="L274">        String requestUrl = &quot;&quot;;</span>
<span class="nc bnc" id="L275" title="All 4 branches missed.">        if (tripId.startsWith(&quot;G&quot;) || tripId.startsWith(&quot;D&quot;)) {</span>
            // ts-order-service:12031/order/create
<span class="nc" id="L277">            requestUrl = &quot;http://ts-order-service:12031/api/v1/orderservice/order&quot;;</span>
        } else {
            //ts-order-other-service:12032/orderOther/create
<span class="nc" id="L280">            requestUrl = &quot;http://ts-order-other-service:12032/api/v1/orderOtherService/orderOther&quot;;</span>
        }
<span class="nc" id="L282">        HttpEntity requestCreateOrder = new HttpEntity(order, httpHeaders);</span>
<span class="nc" id="L283">        ResponseEntity&lt;Response&gt; reCreateOrder = restTemplate.exchange(</span>
                requestUrl,
                HttpMethod.POST,
                requestCreateOrder,
                Response.class);
<span class="nc" id="L288">        return reCreateOrder.getBody();</span>
    }

    private Response updateOrder(Order info, String tripId, HttpHeaders httpHeaders) {
<span class="nc" id="L292">        String requestOrderUtl = &quot;&quot;;</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (tripGD(tripId)) {</span>
<span class="nc" id="L294">            requestOrderUtl = &quot;http://ts-order-service:12031/api/v1/orderservice/order&quot;;</span>
        } else {
<span class="nc" id="L296">            requestOrderUtl = &quot;http://ts-order-other-service:12032/api/v1/orderOtherService/orderOther&quot;;</span>
        }
<span class="nc" id="L298">        HttpEntity requestUpdateOrder = new HttpEntity(info, httpHeaders);</span>
<span class="nc" id="L299">        ResponseEntity&lt;Response&gt; reUpdateOrder = restTemplate.exchange(</span>
                requestOrderUtl,
                HttpMethod.PUT,
                requestUpdateOrder,
                Response.class);
<span class="nc" id="L304">        return reUpdateOrder.getBody();</span>
    }

    private Response deleteOrder(String orderId, String tripId, HttpHeaders httpHeaders) {

<span class="nc" id="L309">        String requestUrl = &quot;&quot;;</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (tripGD(tripId)) {</span>
<span class="nc" id="L311">            requestUrl = &quot;http://ts-order-service:12031/api/v1/orderservice/order/&quot; + orderId;</span>
        } else {
<span class="nc" id="L313">            requestUrl = &quot;http://ts-order-other-service:12032/api/v1/orderOtherService/orderOther/&quot; + orderId;</span>
        }
<span class="nc" id="L315">        HttpEntity requestDeleteOrder = new HttpEntity(httpHeaders);</span>
<span class="nc" id="L316">        ResponseEntity&lt;Response&gt; reDeleteOrder = restTemplate.exchange(</span>
                requestUrl,
                HttpMethod.POST,
                requestDeleteOrder,
                Response.class);

<span class="nc" id="L322">        return reDeleteOrder.getBody();</span>
    }

    private Response&lt;Order&gt; getOrderByRebookInfo(RebookInfo info, HttpHeaders httpHeaders) {
        Response&lt;Order&gt; queryOrderResult;
        //Change can only be changed once, check the status of the order to determine whether it has been changed
<span class="fc" id="L328">        String requestUrl = &quot;&quot;;</span>
<span class="pc bpc" id="L329" title="3 of 4 branches missed.">        if (info.getOldTripId().startsWith(&quot;G&quot;) || info.getOldTripId().startsWith(&quot;D&quot;)) {</span>
<span class="fc" id="L330">            requestUrl = &quot;http://ts-order-service:12031/api/v1/orderservice/order/&quot; + info.getOrderId();</span>
        } else {
<span class="nc" id="L332">            requestUrl = &quot;http://ts-order-other-service:12032/api/v1/orderOtherService/orderOther/&quot; + info.getOrderId();</span>
        }
<span class="fc" id="L334">        HttpEntity requestEntityGetOrderByRebookInfo = new HttpEntity(httpHeaders);</span>
<span class="fc" id="L335">        ResponseEntity&lt;Response&lt;Order&gt;&gt; reGetOrderByRebookInfo = restTemplate.exchange(</span>
                requestUrl,
                HttpMethod.GET,
                requestEntityGetOrderByRebookInfo,
<span class="fc" id="L339">                new ParameterizedTypeReference&lt;Response&lt;Order&gt;&gt;() {</span>
                });
<span class="fc" id="L341">        queryOrderResult = reGetOrderByRebookInfo.getBody();</span>
<span class="fc" id="L342">        return queryOrderResult;</span>
    }

    private String queryForStationName(String stationId, HttpHeaders httpHeaders) {
<span class="fc" id="L346">        HttpEntity requestEntityQueryForStationName = new HttpEntity(httpHeaders);</span>
<span class="fc" id="L347">        ResponseEntity&lt;Response&gt; reQueryForStationName = restTemplate.exchange(</span>
                &quot;http://ts-station-service:12345/api/v1/stationservice/stations/name/&quot; + stationId,
                HttpMethod.GET,
                requestEntityQueryForStationName,
                Response.class);
<span class="fc" id="L352">        Response station = reQueryForStationName.getBody();</span>
<span class="fc" id="L353">        return (String) station.getData();</span>
    }

    private boolean payDifferentMoney(String orderId, String tripId, String userId, String money, HttpHeaders httpHeaders) {
<span class="fc" id="L357">        PaymentDifferenceInfo info = new PaymentDifferenceInfo();</span>
<span class="fc" id="L358">        info.setOrderId(orderId);</span>
<span class="fc" id="L359">        info.setTripId(tripId);</span>
<span class="fc" id="L360">        info.setUserId(userId);</span>
<span class="fc" id="L361">        info.setPrice(money);</span>

<span class="fc" id="L363">        HttpEntity requestEntityPayDifferentMoney = new HttpEntity(info, httpHeaders);</span>
<span class="fc" id="L364">        ResponseEntity&lt;Response&gt; rePayDifferentMoney = restTemplate.exchange(</span>
                &quot;http://ts-inside-payment-service:18673/api/v1/inside_pay_service/inside_payment/difference&quot;,
                HttpMethod.POST,
                requestEntityPayDifferentMoney,
                Response.class);
<span class="fc" id="L369">        Response result = rePayDifferentMoney.getBody();</span>
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">        return result.getStatus() == 1;</span>
    }

    private boolean drawBackMoney(String userId, String money, HttpHeaders httpHeaders) {

<span class="nc" id="L375">        HttpEntity requestEntityDrawBackMoney = new HttpEntity(httpHeaders);</span>
<span class="nc" id="L376">        ResponseEntity&lt;Response&gt; reDrawBackMoney = restTemplate.exchange(</span>
                &quot;http://ts-inside-payment-service:18673/api/v1/inside_pay_service/inside_payment/drawback/&quot; + userId + &quot;/&quot; + money,
                HttpMethod.GET,
                requestEntityDrawBackMoney,
                Response.class);
<span class="nc" id="L381">        Response result = reDrawBackMoney.getBody();</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">        return result.getStatus() == 1;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>