<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InsidePaymentServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ts-inside-payment-service</a> &gt; <a href="index.source.html" class="el_package">inside_payment.service</a> &gt; <span class="el_source">InsidePaymentServiceImpl.java</span></div><h1>InsidePaymentServiceImpl.java</h1><pre class="source lang-java linenums">package inside_payment.service;

import edu.fudan.common.util.Response;
import inside_payment.entity.*;
import inside_payment.repository.AddMoneyRepository;
import inside_payment.repository.PaymentRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.math.BigDecimal;
import java.util.*;

/**
 * @author fdse
 */
@Service
<span class="fc" id="L25">public class InsidePaymentServiceImpl implements InsidePaymentService {</span>

    @Autowired
    public AddMoneyRepository addMoneyRepository;

    @Autowired
    public PaymentRepository paymentRepository;

    @Autowired
    public RestTemplate restTemplate;

<span class="fc" id="L36">    private static final Logger LOGGER = LoggerFactory.getLogger(InsidePaymentServiceImpl.class);</span>

    @Override
    public Response pay(PaymentInfo info, HttpHeaders headers) {

<span class="fc" id="L41">        String userId = info.getUserId();</span>

<span class="fc" id="L43">        String requestOrderURL = &quot;&quot;;</span>
<span class="pc bpc" id="L44" title="3 of 4 branches missed.">        if (info.getTripId().startsWith(&quot;G&quot;) || info.getTripId().startsWith(&quot;D&quot;)) {</span>
<span class="fc" id="L45">            requestOrderURL =  &quot;http://ts-order-service:12031/api/v1/orderservice/order/&quot; + info.getOrderId();</span>
        } else {
<span class="nc" id="L47">            requestOrderURL = &quot;http://ts-order-other-service:12032/api/v1/orderOtherService/orderOther/&quot; + info.getOrderId();</span>
        }
<span class="fc" id="L49">        HttpEntity requestGetOrderResults = new HttpEntity(headers);</span>
<span class="fc" id="L50">        ResponseEntity&lt;Response&lt;Order&gt;&gt; reGetOrderResults = restTemplate.exchange(</span>
                requestOrderURL,
                HttpMethod.GET,
                requestGetOrderResults,
<span class="fc" id="L54">                new ParameterizedTypeReference&lt;Response&lt;Order&gt;&gt;() {</span>
                });
<span class="fc" id="L56">        Response&lt;Order&gt; result = reGetOrderResults.getBody();</span>


<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (result.getStatus() == 1) {</span>
<span class="fc" id="L60">            Order order = result.getData();</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">            if (order.getStatus() != OrderStatus.NOTPAID.getCode()) {</span>
<span class="nc" id="L62">                InsidePaymentServiceImpl.LOGGER.info(&quot;[Inside Payment Service][Pay] Error. Order status Not allowed to Pay.&quot;);</span>
<span class="nc" id="L63">                return new Response&lt;&gt;(0, &quot;Error. Order status Not allowed to Pay.&quot;, null);</span>
            }

<span class="fc" id="L66">            Payment payment = new Payment();</span>
<span class="fc" id="L67">            payment.setOrderId(info.getOrderId());</span>
<span class="fc" id="L68">            payment.setPrice(order.getPrice());</span>
<span class="fc" id="L69">            payment.setUserId(userId);</span>

            //判断一下账户余额够不够，不够要去站外支付
<span class="fc" id="L72">            List&lt;Payment&gt; payments = paymentRepository.findByUserId(userId);</span>
<span class="fc" id="L73">            List&lt;Money&gt; addMonies = addMoneyRepository.findByUserId(userId);</span>
<span class="fc" id="L74">            Iterator&lt;Payment&gt; paymentsIterator = payments.iterator();</span>
<span class="fc" id="L75">            Iterator&lt;Money&gt; addMoniesIterator = addMonies.iterator();</span>

<span class="fc" id="L77">            BigDecimal totalExpand = new BigDecimal(&quot;0&quot;);</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">            while (paymentsIterator.hasNext()) {</span>
<span class="nc" id="L79">                Payment p = paymentsIterator.next();</span>
<span class="nc" id="L80">                totalExpand = totalExpand.add(new BigDecimal(p.getPrice()));</span>
<span class="nc" id="L81">            }</span>
<span class="fc" id="L82">            totalExpand = totalExpand.add(new BigDecimal(order.getPrice()));</span>

<span class="fc" id="L84">            BigDecimal money = new BigDecimal(&quot;0&quot;);</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">            while (addMoniesIterator.hasNext()) {</span>
<span class="fc" id="L86">                Money addMoney = addMoniesIterator.next();</span>
<span class="fc" id="L87">                money = money.add(new BigDecimal(addMoney.getMoney()));</span>
<span class="fc" id="L88">            }</span>

<span class="pc bpc" id="L90" title="1 of 2 branches missed.">            if (totalExpand.compareTo(money) &gt; 0) {</span>
                //站外支付
<span class="nc" id="L92">                Payment outsidePaymentInfo = new Payment();</span>
<span class="nc" id="L93">                outsidePaymentInfo.setOrderId(info.getOrderId());</span>
<span class="nc" id="L94">                outsidePaymentInfo.setUserId(userId);</span>
<span class="nc" id="L95">                outsidePaymentInfo.setPrice(order.getPrice());</span>

                /****这里调用第三方支付***/

<span class="nc" id="L99">                HttpEntity requestEntityOutsidePaySuccess = new HttpEntity(outsidePaymentInfo, headers);</span>
<span class="nc" id="L100">                ResponseEntity&lt;Response&gt; reOutsidePaySuccess = restTemplate.exchange(</span>
                        &quot;http://ts-payment-service:19001/api/v1/paymentservice/payment&quot;,
                        HttpMethod.POST,
                        requestEntityOutsidePaySuccess,
                        Response.class);
<span class="nc" id="L105">                Response outsidePaySuccess = reOutsidePaySuccess.getBody();</span>

<span class="nc" id="L107">                InsidePaymentServiceImpl.LOGGER.info(&quot;Out pay result: {}&quot;, outsidePaySuccess.toString());</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                if (outsidePaySuccess.getStatus() == 1) {</span>
<span class="nc" id="L109">                    payment.setType(PaymentType.O);</span>
<span class="nc" id="L110">                    paymentRepository.save(payment);</span>
<span class="nc" id="L111">                    setOrderStatus(info.getTripId(), info.getOrderId(), headers);</span>
<span class="nc" id="L112">                    return new Response&lt;&gt;(1, &quot;Payment Success &quot; +    outsidePaySuccess.getMsg(), null);</span>
                } else {
<span class="nc" id="L114">                    return new Response&lt;&gt;(0, &quot;Payment Failed:  &quot; +  outsidePaySuccess.getMsg(), null);</span>
                }
            } else {
<span class="fc" id="L117">                setOrderStatus(info.getTripId(), info.getOrderId(), headers);</span>
<span class="fc" id="L118">                payment.setType(PaymentType.P);</span>
<span class="fc" id="L119">                paymentRepository.save(payment);</span>
            }
<span class="fc" id="L121">            return new Response&lt;&gt;(1, &quot;Payment Success&quot;, null);</span>

        } else {
<span class="nc" id="L124">            return new Response&lt;&gt;(0, &quot;Payment Failed, Order Not Exists&quot;, null);</span>
        }
    }

    @Override
    public Response createAccount(AccountInfo info, HttpHeaders headers) {
<span class="fc" id="L130">        List&lt;Money&gt; list = addMoneyRepository.findByUserId(info.getUserId());</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (list.isEmpty()) {</span>
<span class="fc" id="L132">            Money addMoney = new Money();</span>
<span class="fc" id="L133">            addMoney.setMoney(info.getMoney());</span>
<span class="fc" id="L134">            addMoney.setUserId(info.getUserId());</span>
<span class="fc" id="L135">            addMoney.setType(MoneyType.A);</span>
<span class="fc" id="L136">            addMoneyRepository.save(addMoney);</span>
<span class="fc" id="L137">            return new Response&lt;&gt;(1, &quot;Create Account Success&quot;, null);</span>
        } else {
<span class="fc" id="L139">            return new Response&lt;&gt;(0, &quot;Create Account Failed, Account already Exists&quot;, null);</span>
        }
    }

    @Override
    public Response addMoney(String userId, String money, HttpHeaders headers) {
<span class="fc bfc" id="L145" title="All 2 branches covered.">        if (addMoneyRepository.findByUserId(userId) != null) {</span>
<span class="fc" id="L146">            Money addMoney = new Money();</span>
<span class="fc" id="L147">            addMoney.setUserId(userId);</span>
<span class="fc" id="L148">            addMoney.setMoney(money);</span>
<span class="fc" id="L149">            addMoney.setType(MoneyType.A);</span>
<span class="fc" id="L150">            addMoneyRepository.save(addMoney);</span>
<span class="fc" id="L151">            return new Response&lt;&gt;(1, &quot;Add Money Success&quot;, null);</span>
        } else {
<span class="fc" id="L153">            return new Response&lt;&gt;(0, &quot;Add Money Failed&quot;, null);</span>
        }
    }

    @Override
    public Response queryAccount(HttpHeaders headers) {
<span class="fc" id="L159">        List&lt;Balance&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L160">        List&lt;Money&gt; list = addMoneyRepository.findAll();</span>
<span class="fc" id="L161">        Iterator&lt;Money&gt; ite = list.iterator();</span>
<span class="fc" id="L162">        HashMap&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">        while (ite.hasNext()) {</span>
<span class="nc" id="L164">            Money addMoney = ite.next();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (map.containsKey(addMoney.getUserId())) {</span>
<span class="nc" id="L166">                BigDecimal money = new BigDecimal(map.get(addMoney.getUserId()));</span>
<span class="nc" id="L167">                map.put(addMoney.getUserId(), money.add(new BigDecimal(addMoney.getMoney())).toString());</span>
<span class="nc" id="L168">            } else {</span>
<span class="nc" id="L169">                map.put(addMoney.getUserId(), addMoney.getMoney());</span>
            }
<span class="nc" id="L171">        }</span>

<span class="fc" id="L173">        Iterator ite1 = map.entrySet().iterator();</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        while (ite1.hasNext()) {</span>
<span class="nc" id="L175">            Map.Entry entry = (Map.Entry) ite1.next();</span>
<span class="nc" id="L176">            String userId = (String) entry.getKey();</span>
<span class="nc" id="L177">            String money = (String) entry.getValue();</span>

<span class="nc" id="L179">            List&lt;Payment&gt; payments = paymentRepository.findByUserId(userId);</span>
<span class="nc" id="L180">            Iterator&lt;Payment&gt; iterator = payments.iterator();</span>
<span class="nc" id="L181">            String totalExpand = &quot;0&quot;;</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            while (iterator.hasNext()) {</span>
<span class="nc" id="L183">                Payment p = iterator.next();</span>
<span class="nc" id="L184">                BigDecimal expand = new BigDecimal(totalExpand);</span>
<span class="nc" id="L185">                totalExpand = expand.add(new BigDecimal(p.getPrice())).toString();</span>
<span class="nc" id="L186">            }</span>
<span class="nc" id="L187">            String balanceMoney = new BigDecimal(money).subtract(new BigDecimal(totalExpand)).toString();</span>
<span class="nc" id="L188">            Balance balance = new Balance();</span>
<span class="nc" id="L189">            balance.setUserId(userId);</span>
<span class="nc" id="L190">            balance.setBalance(balanceMoney);</span>
<span class="nc" id="L191">            result.add(balance);</span>
<span class="nc" id="L192">        }</span>

<span class="fc" id="L194">        return new Response&lt;&gt;(1, &quot;Success&quot;, result);</span>
    }

    public String queryAccount(String userId, HttpHeaders headers) {
<span class="nc" id="L198">        List&lt;Payment&gt; payments = paymentRepository.findByUserId(userId);</span>
<span class="nc" id="L199">        List&lt;Money&gt; addMonies = addMoneyRepository.findByUserId(userId);</span>
<span class="nc" id="L200">        Iterator&lt;Payment&gt; paymentsIterator = payments.iterator();</span>
<span class="nc" id="L201">        Iterator&lt;Money&gt; addMoniesIterator = addMonies.iterator();</span>

<span class="nc" id="L203">        BigDecimal totalExpand = new BigDecimal(&quot;0&quot;);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        while (paymentsIterator.hasNext()) {</span>
<span class="nc" id="L205">            Payment p = paymentsIterator.next();</span>
<span class="nc" id="L206">            totalExpand.add(new BigDecimal(p.getPrice()));</span>
<span class="nc" id="L207">        }</span>

<span class="nc" id="L209">        BigDecimal money = new BigDecimal(&quot;0&quot;);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">        while (addMoniesIterator.hasNext()) {</span>
<span class="nc" id="L211">            Money addMoney = addMoniesIterator.next();</span>
<span class="nc" id="L212">            money.add(new BigDecimal(addMoney.getMoney()));</span>
<span class="nc" id="L213">        }</span>

<span class="nc" id="L215">        return money.subtract(totalExpand).toString();</span>
    }

    @Override
    public Response queryPayment(HttpHeaders headers) {
<span class="fc" id="L220">        List&lt;Payment&gt; payments = paymentRepository.findAll();</span>
<span class="pc bpc" id="L221" title="1 of 4 branches missed.">        if (payments != null &amp;&amp; !payments.isEmpty()) {</span>
<span class="fc" id="L222">            return new Response&lt;&gt;(1, &quot;Query Payment Success&quot;, payments);</span>
        }else {
<span class="fc" id="L224">            return new Response&lt;&gt;(0, &quot;Query Payment Failed&quot;, null);</span>
        }
    }

    @Override
    public Response drawBack(String userId, String money, HttpHeaders headers) {
<span class="fc bfc" id="L230" title="All 2 branches covered.">        if (addMoneyRepository.findByUserId(userId) != null) {</span>
<span class="fc" id="L231">            Money addMoney = new Money();</span>
<span class="fc" id="L232">            addMoney.setUserId(userId);</span>
<span class="fc" id="L233">            addMoney.setMoney(money);</span>
<span class="fc" id="L234">            addMoney.setType(MoneyType.D);</span>
<span class="fc" id="L235">            addMoneyRepository.save(addMoney);</span>
<span class="fc" id="L236">            return new Response&lt;&gt;(1, &quot;Draw Back Money Success&quot;, null);</span>
        } else {
<span class="fc" id="L238">            return new Response&lt;&gt;(0, &quot;Draw Back Money Failed&quot;, null);</span>
        }
    }

    @Override
    public Response payDifference(PaymentInfo info, HttpHeaders headers) {

<span class="fc" id="L245">        String userId = info.getUserId();</span>

<span class="fc" id="L247">        Payment payment = new Payment();</span>
<span class="fc" id="L248">        payment.setOrderId(info.getOrderId());</span>
<span class="fc" id="L249">        payment.setPrice(info.getPrice());</span>
<span class="fc" id="L250">        payment.setUserId(info.getUserId());</span>


<span class="fc" id="L253">        List&lt;Payment&gt; payments = paymentRepository.findByUserId(userId);</span>
<span class="fc" id="L254">        List&lt;Money&gt; addMonies = addMoneyRepository.findByUserId(userId);</span>
<span class="fc" id="L255">        Iterator&lt;Payment&gt; paymentsIterator = payments.iterator();</span>
<span class="fc" id="L256">        Iterator&lt;Money&gt; addMoniesIterator = addMonies.iterator();</span>

<span class="fc" id="L258">        BigDecimal totalExpand = new BigDecimal(&quot;0&quot;);</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">        while (paymentsIterator.hasNext()) {</span>
<span class="nc" id="L260">            Payment p = paymentsIterator.next();</span>
<span class="nc" id="L261">            totalExpand.add(new BigDecimal(p.getPrice()));</span>
<span class="nc" id="L262">        }</span>
<span class="fc" id="L263">        totalExpand.add(new BigDecimal(info.getPrice()));</span>

<span class="fc" id="L265">        BigDecimal money = new BigDecimal(&quot;0&quot;);</span>
<span class="fc bfc" id="L266" title="All 2 branches covered.">        while (addMoniesIterator.hasNext()) {</span>
<span class="fc" id="L267">            Money addMoney = addMoniesIterator.next();</span>
<span class="fc" id="L268">            money.add(new BigDecimal(addMoney.getMoney()));</span>
<span class="fc" id="L269">        }</span>

<span class="pc bpc" id="L271" title="1 of 2 branches missed.">        if (totalExpand.compareTo(money) &gt; 0) {</span>
            //站外支付
<span class="nc" id="L273">            Payment outsidePaymentInfo = new Payment();</span>
<span class="nc" id="L274">            outsidePaymentInfo.setOrderId(info.getOrderId());</span>
<span class="nc" id="L275">            outsidePaymentInfo.setUserId(userId);</span>
<span class="nc" id="L276">            outsidePaymentInfo.setPrice(info.getPrice());</span>

<span class="nc" id="L278">            HttpEntity requestEntityOutsidePaySuccess = new HttpEntity(outsidePaymentInfo, headers);</span>
<span class="nc" id="L279">            ResponseEntity&lt;Response&gt; reOutsidePaySuccess = restTemplate.exchange(</span>
                    &quot;http://ts-payment-service:19001/api/v1/paymentservice/payment&quot;,
                    HttpMethod.POST,
                    requestEntityOutsidePaySuccess,
                    Response.class);
<span class="nc" id="L284">            Response outsidePaySuccess = reOutsidePaySuccess.getBody();</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (outsidePaySuccess.getStatus() == 1) {</span>
<span class="nc" id="L287">                payment.setType(PaymentType.E);</span>
<span class="nc" id="L288">                paymentRepository.save(payment);</span>
<span class="nc" id="L289">                return new Response&lt;&gt;(1, &quot;Pay Difference Success&quot;, null);</span>
            } else {
<span class="nc" id="L291">                return new Response&lt;&gt;(0, &quot;Pay Difference Failed&quot;, null);</span>
            }
        } else {
<span class="fc" id="L294">            payment.setType(PaymentType.E);</span>
<span class="fc" id="L295">            paymentRepository.save(payment);</span>
        }
<span class="fc" id="L297">        return new Response&lt;&gt;(1, &quot;Pay Difference Success&quot;, null);</span>
    }

    @Override
    public Response queryAddMoney(HttpHeaders headers) {
<span class="fc" id="L302">        List&lt;Money&gt; monies = addMoneyRepository.findAll();</span>
<span class="pc bpc" id="L303" title="1 of 4 branches missed.">        if (monies != null &amp;&amp; !monies.isEmpty()) {</span>
<span class="fc" id="L304">            return new Response&lt;&gt;(1, &quot;Query Money Success&quot;, null);</span>
        } else {
<span class="fc" id="L306">            return new Response&lt;&gt;(0, &quot;&quot;, null);</span>
        }
    }

    private Response setOrderStatus(String tripId, String orderId, HttpHeaders headers) {

        //order paid and not collected
<span class="fc" id="L313">        int orderStatus = 1;</span>
        Response result;
<span class="pc bpc" id="L315" title="3 of 4 branches missed.">        if (tripId.startsWith(&quot;G&quot;) || tripId.startsWith(&quot;D&quot;)) {</span>

<span class="fc" id="L317">            HttpEntity requestEntityModifyOrderStatusResult = new HttpEntity(headers);</span>
<span class="fc" id="L318">            ResponseEntity&lt;Response&gt; reModifyOrderStatusResult = restTemplate.exchange(</span>
                    &quot;http://ts-order-service:12031/api/v1/orderservice/order/status/&quot; + orderId + &quot;/&quot; + orderStatus,
                    HttpMethod.GET,
                    requestEntityModifyOrderStatusResult,
                    Response.class);
<span class="fc" id="L323">            result = reModifyOrderStatusResult.getBody();</span>

<span class="fc" id="L325">        } else {</span>
<span class="nc" id="L326">            HttpEntity requestEntityModifyOrderStatusResult = new HttpEntity(headers);</span>
<span class="nc" id="L327">            ResponseEntity&lt;Response&gt; reModifyOrderStatusResult = restTemplate.exchange(</span>
                    &quot;http://ts-order-other-service:12032/api/v1/orderOtherService/orderOther/status/&quot; + orderId + &quot;/&quot; + orderStatus,
                    HttpMethod.GET,
                    requestEntityModifyOrderStatusResult,
                    Response.class);
<span class="nc" id="L332">            result = reModifyOrderStatusResult.getBody();</span>

        }
<span class="fc" id="L335">        return result;</span>
    }

    @Override
    public void initPayment(Payment payment, HttpHeaders headers) {
<span class="fc" id="L340">        Payment paymentTemp = paymentRepository.findById(payment.getId());</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">        if (paymentTemp == null) {</span>
<span class="fc" id="L342">            paymentRepository.save(payment);</span>
        } else {
<span class="fc" id="L344">            InsidePaymentServiceImpl.LOGGER.info(&quot;[Inside Payment Service][Init Payment] Already Exists: {}&quot;, payment.getId());</span>
        }
<span class="fc" id="L346">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>