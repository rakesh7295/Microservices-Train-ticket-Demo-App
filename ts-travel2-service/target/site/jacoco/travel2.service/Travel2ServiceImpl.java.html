<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Travel2ServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ts-travel2-service</a> &gt; <a href="index.source.html" class="el_package">travel2.service</a> &gt; <span class="el_source">Travel2ServiceImpl.java</span></div><h1>Travel2ServiceImpl.java</h1><pre class="source lang-java linenums">package travel2.service;

import edu.fudan.common.util.JsonUtils;
import edu.fudan.common.util.Response;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import travel2.entity.*;
import travel2.repository.TripRepository;

import java.util.*;

/**
 * @author fdse
 */
@Service
<span class="fc" id="L24">public class Travel2ServiceImpl implements Travel2Service {</span>

    @Autowired
    TripRepository repository;

    @Autowired
    private RestTemplate restTemplate;

<span class="fc" id="L32">    private static final Logger LOGGER = LoggerFactory.getLogger(Travel2ServiceImpl.class);</span>

<span class="fc" id="L34">    String success = &quot;Success&quot;;</span>
<span class="fc" id="L35">    String noCnontent = &quot;No Content&quot;;</span>

    @Override
    public Response getRouteByTripId(String tripId, HttpHeaders headers) {
<span class="fc" id="L39">        TripId tripId1 = new TripId(tripId);</span>

<span class="fc" id="L41">        Trip trip = repository.findByTripId(tripId1);</span>
<span class="fc bfc" id="L42" title="All 2 branches covered.">        if (trip == null) {</span>
<span class="fc" id="L43">            Travel2ServiceImpl.LOGGER.info(&quot;[Get Route By Trip ID] Trip Not Found: {}&quot;, tripId);</span>
<span class="fc" id="L44">            return new Response&lt;&gt;(0, &quot;\&quot;[Get Route By Trip ID] Trip Not Found:\&quot; + tripId&quot;, null);</span>
        } else {
<span class="fc" id="L46">            Route route = getRouteByRouteId(trip.getRouteId(), headers);</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">            if (route == null) {</span>
<span class="nc" id="L48">                return new Response&lt;&gt;(0, &quot;\&quot;[Get Route By Trip ID] Route Not Found:\&quot; + trip.getRouteId()&quot;, null);</span>
            } else {
<span class="fc" id="L50">                Travel2ServiceImpl.LOGGER.info(&quot;[Get Route By Trip ID] Success&quot;);</span>
<span class="fc" id="L51">                return new Response&lt;&gt;(1, &quot;[Get Route By Trip ID] Success&quot;, route);</span>
            }
        }
    }


    @Override
    public Response getTrainTypeByTripId(String tripId, HttpHeaders headers) {
<span class="fc" id="L59">        TripId tripId1 = new TripId(tripId);</span>
<span class="fc" id="L60">        TrainType trainType = null;</span>
<span class="fc" id="L61">        Trip trip = repository.findByTripId(tripId1);</span>
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">        if (trip != null) {</span>
<span class="fc" id="L63">            trainType = getTrainType(trip.getTrainTypeId(), headers);</span>
        }
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">        if (trainType != null) {</span>
<span class="fc" id="L66">            return new Response&lt;&gt;(1, &quot;Success query Train by trip id&quot;, trainType);</span>
        } else {
<span class="nc" id="L68">            return new Response&lt;&gt;(0, noCnontent, null);</span>
        }
    }

    @Override
    public Response getTripByRoute(ArrayList&lt;String&gt; routeIds, HttpHeaders headers) {
<span class="fc" id="L74">        ArrayList&lt;ArrayList&lt;Trip&gt;&gt; tripList = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        for (String routeId : routeIds) {</span>
<span class="fc" id="L76">            ArrayList&lt;Trip&gt; tempTripList = repository.findByRouteId(routeId);</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">            if (tempTripList == null) {</span>
<span class="fc" id="L78">                tempTripList = new ArrayList&lt;&gt;();</span>
            }
<span class="fc" id="L80">            tripList.add(tempTripList);</span>
<span class="fc" id="L81">        }</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">        if (!tripList.isEmpty()) {</span>
<span class="fc" id="L83">            return new Response&lt;&gt;(1, success, tripList);</span>
        } else {
<span class="fc" id="L85">            return new Response&lt;&gt;(0, noCnontent, null);</span>
        }
    }

    @Override
    public Response create(TravelInfo info, HttpHeaders headers) {
<span class="fc" id="L91">        TripId ti = new TripId(info.getTripId());</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">        if (repository.findByTripId(ti) == null) {</span>
<span class="fc" id="L93">            Trip trip = new Trip(ti, info.getTrainTypeId(), info.getStartingStationId(),</span>
<span class="fc" id="L94">                    info.getStationsId(), info.getTerminalStationId(), info.getStartingTime(), info.getEndTime());</span>
<span class="fc" id="L95">            trip.setRouteId(info.getRouteId());</span>
<span class="fc" id="L96">            repository.save(trip);</span>
<span class="fc" id="L97">            return new Response&lt;&gt;(1, &quot;Create trip info:&quot; + ti.toString() + &quot;.&quot;, null);</span>
        } else {
<span class="fc" id="L99">            return new Response&lt;&gt;(1, &quot;Trip &quot; + info.getTripId() + &quot; already exists&quot;, null);</span>
        }
    }

    @Override
    public Response retrieve(String tripId, HttpHeaders headers) {
<span class="fc" id="L105">        TripId ti = new TripId(tripId);</span>
<span class="fc" id="L106">        Trip trip = repository.findByTripId(ti);</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (trip != null) {</span>
<span class="fc" id="L108">            return new Response&lt;&gt;(1, &quot;Search Trip Success by Trip Id &quot; + tripId, trip);</span>
        } else {
<span class="nc" id="L110">            return new Response&lt;&gt;(0, &quot;No Content according to tripId&quot; + tripId, null);</span>
        }
    }

    @Override
    public Response update(TravelInfo info, HttpHeaders headers) {
<span class="fc" id="L116">        TripId ti = new TripId(info.getTripId());</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">        if (repository.findByTripId(ti) != null) {</span>
<span class="fc" id="L118">            Trip trip = new Trip(ti, info.getTrainTypeId(), info.getStartingStationId(),</span>
<span class="fc" id="L119">                    info.getStationsId(), info.getTerminalStationId(), info.getStartingTime(), info.getEndTime());</span>
<span class="fc" id="L120">            trip.setRouteId(info.getRouteId());</span>
<span class="fc" id="L121">            repository.save(trip);</span>
<span class="fc" id="L122">            return new Response&lt;&gt;(1, &quot;Update trip info:&quot; + ti.toString(), trip);</span>
        } else {
<span class="fc" id="L124">            return new Response&lt;&gt;(1, &quot;Trip&quot; + info.getTripId() + &quot;doesn 't exists&quot;, null);</span>
        }
    }

    @Override
    public Response delete(String tripId, HttpHeaders headers) {
<span class="fc" id="L130">        TripId ti = new TripId(tripId);</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (repository.findByTripId(ti) != null) {</span>
<span class="fc" id="L132">            repository.deleteByTripId(ti);</span>
<span class="fc" id="L133">            return new Response&lt;&gt;(1, &quot;Delete trip:&quot; + tripId + &quot;.&quot;, tripId);</span>
        } else {
<span class="fc" id="L135">            return new Response&lt;&gt;(0, &quot;Trip &quot; + tripId + &quot; doesn't exist.&quot;, null);</span>
        }
    }

    @Override
    public Response query(TripInfo info, HttpHeaders headers) {

        //Gets the start and arrival stations of the train number to query. The originating and arriving stations received here are both station names, so two requests need to be sent to convert to station ids
<span class="fc" id="L143">        String startingPlaceName = info.getStartingPlace();</span>
<span class="fc" id="L144">        String endPlaceName = info.getEndPlace();</span>
<span class="fc" id="L145">        String startingPlaceId = queryForStationId(startingPlaceName, headers);</span>
<span class="fc" id="L146">        String endPlaceId = queryForStationId(endPlaceName, headers);</span>

        //This is the final result
<span class="fc" id="L149">        ArrayList&lt;TripResponse&gt; list = new ArrayList&lt;&gt;();</span>

        //Check all train info
<span class="fc" id="L152">        ArrayList&lt;Trip&gt; allTripList = repository.findAll();</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">        for (Trip tempTrip : allTripList) {</span>
            //Get the detailed route list of this train
<span class="fc" id="L155">            Route tempRoute = getRouteByRouteId(tempTrip.getRouteId(), headers);</span>
            //Check the route list for this train. Check that the required start and arrival stations are in the list of stops that are not on the route, and check that the location of the start station is before the stop
            //Trains that meet the above criteria are added to the return list
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">            if (tempRoute.getStations().contains(startingPlaceId) &amp;&amp;</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">                    tempRoute.getStations().contains(endPlaceId) &amp;&amp;</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                    tempRoute.getStations().indexOf(startingPlaceId) &lt; tempRoute.getStations().indexOf(endPlaceId)) {</span>
<span class="nc" id="L161">                TripResponse response = getTickets(tempTrip, tempRoute, startingPlaceId, endPlaceId, startingPlaceName, endPlaceName, info.getDepartureTime(), headers);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                if (response == null) {</span>
<span class="nc" id="L163">                    return new Response&lt;&gt;(0, noCnontent, null);</span>
                }
<span class="nc" id="L165">                list.add(response);</span>
            }
<span class="fc" id="L167">        }</span>
<span class="fc" id="L168">        return new Response&lt;&gt;(1, &quot;Success Query&quot;, list);</span>
    }

    @Override
    public Response getTripAllDetailInfo(TripAllDetailInfo gtdi, HttpHeaders headers) {
<span class="fc" id="L173">        TripAllDetail gtdr = new TripAllDetail();</span>
<span class="fc" id="L174">        Travel2ServiceImpl.LOGGER.info(&quot;[TravelService] [getTripAllDetailInfo] gtdi info: {}&quot;, gtdi.toString());</span>
<span class="fc" id="L175">        Trip trip = repository.findByTripId(new TripId(gtdi.getTripId()));</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        if (trip == null) {</span>
<span class="nc" id="L177">            gtdr.setTripResponse(null);</span>
<span class="nc" id="L178">            gtdr.setTrip(null);</span>
        } else {
<span class="fc" id="L180">            String endPlaceName = gtdi.getTo();</span>
<span class="fc" id="L181">            String startingPlaceName = gtdi.getFrom();</span>
<span class="fc" id="L182">            String startingPlaceId = queryForStationId(startingPlaceName, headers);</span>
<span class="fc" id="L183">            String endPlaceId = queryForStationId(endPlaceName, headers);</span>
<span class="fc" id="L184">            Travel2ServiceImpl.LOGGER.info(&quot;[TravelService] [getTripAllDetailInfo] endPlaceID: {}&quot;, endPlaceId);</span>
<span class="fc" id="L185">            Route tempRoute = getRouteByRouteId(trip.getRouteId(), headers);</span>
<span class="fc" id="L186">            TripResponse tripResponse = getTickets(trip, tempRoute, startingPlaceId, endPlaceId, gtdi.getFrom(), gtdi.getTo(), gtdi.getTravelDate(), headers);</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">            if (tripResponse == null) {</span>
<span class="fc" id="L188">                gtdr.setTrip(null);</span>
<span class="fc" id="L189">                gtdr.setTripResponse(null);</span>
            } else {
<span class="nc" id="L191">                gtdr.setTripResponse(tripResponse);</span>
<span class="nc" id="L192">                gtdr.setTrip(repository.findByTripId(new TripId(gtdi.getTripId())));</span>
            }
        }


<span class="fc" id="L197">        return new Response&lt;&gt;(1, success, gtdr);</span>
    }


    private TripResponse getTickets(Trip trip, Route route, String startingPlaceId, String endPlaceId, String startingPlaceName, String endPlaceName, Date departureTime, HttpHeaders headers) {

        //Determine if the date checked is the same day and after
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">        if (!afterToday(departureTime)) {</span>
<span class="fc" id="L205">            return null;</span>
        }

<span class="nc" id="L208">        Travel query = new Travel();</span>
<span class="nc" id="L209">        query.setTrip(trip);</span>
<span class="nc" id="L210">        query.setStartingPlace(startingPlaceName);</span>
<span class="nc" id="L211">        query.setEndPlace(endPlaceName);</span>
<span class="nc" id="L212">        query.setDepartureTime(departureTime);</span>

<span class="nc" id="L214">        HttpEntity requestEntity = new HttpEntity(query, headers);</span>
<span class="nc" id="L215">        ResponseEntity&lt;Response&lt;TravelResult&gt;&gt; re = restTemplate.exchange(</span>
                &quot;http://ts-ticketinfo-service:15681/api/v1/ticketinfoservice/ticketinfo&quot;,
                HttpMethod.POST,
                requestEntity,
<span class="nc" id="L219">                new ParameterizedTypeReference&lt;Response&lt;TravelResult&gt;&gt;() {</span>
                });
<span class="nc" id="L221">        Travel2ServiceImpl.LOGGER.info(&quot;Ticket info  is: {}&quot;, re.getBody().toString());</span>
<span class="nc" id="L222">        TravelResult resultForTravel =  re.getBody().getData();</span>



        //Ticket order _ high-speed train (number of tickets purchased)
<span class="nc" id="L227">        requestEntity = new HttpEntity(headers);</span>
<span class="nc" id="L228">        ResponseEntity&lt;Response&lt;SoldTicket&gt;&gt; re2 = restTemplate.exchange(</span>
<span class="nc" id="L229">                &quot;http://ts-order-other-service:12032/api/v1/orderOtherService/orderOther/&quot; + departureTime + &quot;/&quot; + trip.getTripId().toString(),</span>
                HttpMethod.GET,
                requestEntity,
<span class="nc" id="L232">                new ParameterizedTypeReference&lt;Response&lt;SoldTicket&gt;&gt;() {</span>
                });
<span class="nc" id="L234">        Travel2ServiceImpl.LOGGER.info(&quot;Order other Ticket info  is: {}&quot;, re.getBody().toString());</span>
<span class="nc" id="L235">        SoldTicket result = re2.getBody().getData();</span>

<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (result == null) {</span>
<span class="nc" id="L238">            Travel2ServiceImpl.LOGGER.info(&quot;soldticket Info doesn't exist&quot;);</span>
<span class="nc" id="L239">            return null;</span>
        }
        //Set the returned ticket information
<span class="nc" id="L242">        TripResponse response = new TripResponse();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (queryForStationId(startingPlaceName, headers).equals(trip.getStartingStationId()) &amp;&amp;</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                queryForStationId(endPlaceName, headers).equals(trip.getTerminalStationId())) {</span>
<span class="nc" id="L245">            response.setEconomyClass(50);</span>
<span class="nc" id="L246">            response.setConfortClass(50);</span>
        } else {
<span class="nc" id="L248">            response.setConfortClass(50);</span>
<span class="nc" id="L249">            response.setEconomyClass(50);</span>
        }

<span class="nc" id="L252">        int first = getRestTicketNumber(departureTime, trip.getTripId().toString(),</span>
<span class="nc" id="L253">                startingPlaceName, endPlaceName, SeatClass.FIRSTCLASS.getCode(), headers);</span>

<span class="nc" id="L255">        int second = getRestTicketNumber(departureTime, trip.getTripId().toString(),</span>
<span class="nc" id="L256">                startingPlaceName, endPlaceName, SeatClass.SECONDCLASS.getCode(), headers);</span>
<span class="nc" id="L257">        response.setConfortClass(first);</span>
<span class="nc" id="L258">        response.setEconomyClass(second);</span>

<span class="nc" id="L260">        response.setStartingStation(startingPlaceName);</span>
<span class="nc" id="L261">        response.setTerminalStation(endPlaceName);</span>

        //Calculate the distance from the starting point
<span class="nc" id="L264">        Travel2ServiceImpl.LOGGER.info(&quot;[TravelService][getTickets] route: {}  station: {}&quot;, route.getId(), route.getStations());</span>
<span class="nc" id="L265">        int indexStart = route.getStations().indexOf(startingPlaceId);</span>
<span class="nc" id="L266">        int indexEnd = route.getStations().indexOf(endPlaceId);</span>
<span class="nc" id="L267">        int distanceStart = route.getDistances().get(indexStart) - route.getDistances().get(0);</span>
<span class="nc" id="L268">        int distanceEnd = route.getDistances().get(indexEnd) - route.getDistances().get(0);</span>
<span class="nc" id="L269">        TrainType trainType = getTrainType(trip.getTrainTypeId(), headers);</span>
        //Train running time is calculated according to the average running speed of the train
<span class="nc" id="L271">        int minutesStart = 60 * distanceStart / trainType.getAverageSpeed();</span>
<span class="nc" id="L272">        int minutesEnd = 60 * distanceEnd / trainType.getAverageSpeed();</span>

<span class="nc" id="L274">        Calendar calendarStart = Calendar.getInstance();</span>
<span class="nc" id="L275">        calendarStart.setTime(trip.getStartingTime());</span>
<span class="nc" id="L276">        calendarStart.add(Calendar.MINUTE, minutesStart);</span>
<span class="nc" id="L277">        response.setStartingTime(calendarStart.getTime());</span>
<span class="nc" id="L278">        Travel2ServiceImpl.LOGGER.info(&quot;[Train Service] calculate time：{}  time: {}&quot;, minutesStart, calendarStart.getTime());</span>

<span class="nc" id="L280">        Calendar calendarEnd = Calendar.getInstance();</span>
<span class="nc" id="L281">        calendarEnd.setTime(trip.getStartingTime());</span>
<span class="nc" id="L282">        calendarEnd.add(Calendar.MINUTE, minutesEnd);</span>
<span class="nc" id="L283">        response.setEndTime(calendarEnd.getTime());</span>
<span class="nc" id="L284">        Travel2ServiceImpl.LOGGER.info(&quot;[Train Service] calculate time：{}  time: {}&quot;, minutesEnd, calendarEnd.getTime());</span>

<span class="nc" id="L286">        response.setTripId(new TripId(result.getTrainNumber()));</span>
<span class="nc" id="L287">        response.setTrainTypeId(trip.getTrainTypeId());</span>
<span class="nc" id="L288">        response.setPriceForConfortClass(resultForTravel.getPrices().get(&quot;confortClass&quot;));</span>
<span class="nc" id="L289">        response.setPriceForEconomyClass(resultForTravel.getPrices().get(&quot;economyClass&quot;));</span>

<span class="nc" id="L291">        return response;</span>
    }

    @Override
    public Response queryAll(HttpHeaders headers) {
<span class="fc" id="L296">        List&lt;Trip&gt; tripList = repository.findAll();</span>
<span class="pc bpc" id="L297" title="1 of 4 branches missed.">        if (tripList != null &amp;&amp; !tripList.isEmpty()) {</span>
<span class="fc" id="L298">            return new Response&lt;&gt;(1, success, tripList);</span>
        }
<span class="fc" id="L300">        return new Response&lt;&gt;(0, noCnontent, null);</span>
    }

    private static boolean afterToday(Date date) {
<span class="fc" id="L304">        Calendar calDateA = Calendar.getInstance();</span>
<span class="fc" id="L305">        Date today = new Date();</span>
<span class="fc" id="L306">        calDateA.setTime(today);</span>

<span class="fc" id="L308">        Calendar calDateB = Calendar.getInstance();</span>
<span class="fc" id="L309">        calDateB.setTime(date);</span>

<span class="pc bpc" id="L311" title="1 of 2 branches missed.">        if (calDateA.get(Calendar.YEAR) &gt; calDateB.get(Calendar.YEAR)) {</span>
<span class="nc" id="L312">            return false;</span>
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">        } else if (calDateA.get(Calendar.YEAR) == calDateB.get(Calendar.YEAR)) {</span>
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">            if (calDateA.get(Calendar.MONTH) &gt; calDateB.get(Calendar.MONTH)) {</span>
<span class="nc" id="L315">                return false;</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">            } else if (calDateA.get(Calendar.MONTH) == calDateB.get(Calendar.MONTH)) {</span>
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">                return calDateA.get(Calendar.DAY_OF_MONTH) &lt;= calDateB.get(Calendar.DAY_OF_MONTH);</span>
            } else {
<span class="nc" id="L319">                return true;</span>
            }
        } else {
<span class="nc" id="L322">            return true;</span>
        }
    }

    private TrainType getTrainType(String trainTypeId, HttpHeaders headers) {

<span class="fc" id="L328">        HttpEntity requestEntity = new HttpEntity(headers);</span>
<span class="fc" id="L329">        ResponseEntity&lt;Response&lt;TrainType&gt;&gt; re = restTemplate.exchange(</span>
                &quot;http://ts-train-service:14567/api/v1/trainservice/trains/&quot; + trainTypeId,
                HttpMethod.GET,
                requestEntity,
<span class="fc" id="L333">                new ParameterizedTypeReference&lt;Response&lt;TrainType&gt;&gt;() {</span>
                });

<span class="fc" id="L336">        return re.getBody().getData();</span>
    }

    private String queryForStationId(String stationName, HttpHeaders headers) {
<span class="fc" id="L340">        HttpEntity requestEntity = new HttpEntity(headers);</span>
<span class="fc" id="L341">        ResponseEntity&lt;Response&lt;String&gt;&gt; re = restTemplate.exchange(</span>
                &quot;http://ts-ticketinfo-service:15681/api/v1/ticketinfoservice/ticketinfo/&quot; + stationName,
                HttpMethod.GET,
                requestEntity,
<span class="fc" id="L345">                new ParameterizedTypeReference&lt;Response&lt;String&gt;&gt;() {</span>
                });


<span class="fc" id="L349">        return re.getBody().getData();</span>
    }

    private Route getRouteByRouteId(String routeId, HttpHeaders headers) {
<span class="fc" id="L353">        Travel2ServiceImpl.LOGGER.info(&quot;[Travel Service][Get Route By Id] Route ID：{}&quot;, routeId);</span>
<span class="fc" id="L354">        HttpEntity requestEntity = new HttpEntity(headers);</span>
<span class="fc" id="L355">        ResponseEntity&lt;Response&gt; re = restTemplate.exchange(</span>
                &quot;http://ts-route-service:11178/api/v1/routeservice/routes/&quot; + routeId,
                HttpMethod.GET,
                requestEntity,
                Response.class);
<span class="fc" id="L360">        Response result = re.getBody();</span>

<span class="pc bpc" id="L362" title="1 of 2 branches missed.">        if (result.getStatus() == 0 ) {</span>
<span class="nc" id="L363">            Travel2ServiceImpl.LOGGER.info(&quot;[Travel Other Service][Get Route By Id] Fail. {}&quot;, result.getMsg());</span>
<span class="nc" id="L364">            return null;</span>
        } else {
<span class="fc" id="L366">            Travel2ServiceImpl.LOGGER.info(&quot;[Travel Other Service][Get Route By Id] Success.&quot;);</span>
<span class="fc" id="L367">            return JsonUtils.conveterObject(result.getData(), Route.class);</span>
        }
    }

    private int getRestTicketNumber(Date travelDate, String trainNumber, String startStationName, String endStationName, int seatType, HttpHeaders headers) {
<span class="nc" id="L372">        Seat seatRequest = new Seat();</span>

<span class="nc" id="L374">        String fromId = queryForStationId(startStationName, headers);</span>
<span class="nc" id="L375">        String toId = queryForStationId(endStationName, headers);</span>

<span class="nc" id="L377">        seatRequest.setDestStation(toId);</span>
<span class="nc" id="L378">        seatRequest.setStartStation(fromId);</span>
<span class="nc" id="L379">        seatRequest.setTrainNumber(trainNumber);</span>
<span class="nc" id="L380">        seatRequest.setSeatType(seatType);</span>
<span class="nc" id="L381">        seatRequest.setTravelDate(travelDate);</span>
<span class="nc" id="L382">        Travel2ServiceImpl.LOGGER.info(&quot;Seat request To String: {}&quot;, seatRequest.toString());</span>

<span class="nc" id="L384">        HttpEntity requestEntity = new HttpEntity(seatRequest, headers);</span>
<span class="nc" id="L385">        ResponseEntity&lt;Response&lt;Integer&gt;&gt; re = restTemplate.exchange(</span>
                &quot;http://ts-seat-service:18898/api/v1/seatservice/seats/left_tickets&quot;,
                HttpMethod.POST,
                requestEntity,
<span class="nc" id="L389">                new ParameterizedTypeReference&lt;Response&lt;Integer&gt;&gt;() {</span>
                });
<span class="nc" id="L391">        int restNumber =   re.getBody().getData();</span>

<span class="nc" id="L393">        Travel2ServiceImpl.LOGGER.info(&quot;Get Rest tickets num is: {}&quot;, re.getBody().toString());</span>
<span class="nc" id="L394">        return restNumber;</span>
    }

    @Override
    public Response adminQueryAll(HttpHeaders headers) {
<span class="fc" id="L399">        List&lt;Trip&gt; trips = repository.findAll();</span>
<span class="fc" id="L400">        ArrayList&lt;AdminTrip&gt; adminTrips = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L401" title="All 2 branches covered.">        for (Trip trip : trips) {</span>
<span class="fc" id="L402">            AdminTrip adminTrip = new AdminTrip();</span>
<span class="fc" id="L403">            adminTrip.setRoute(getRouteByRouteId(trip.getRouteId(), headers));</span>
<span class="fc" id="L404">            adminTrip.setTrainType(getTrainType(trip.getTrainTypeId(), headers));</span>
<span class="fc" id="L405">            adminTrip.setTrip(trip);</span>
<span class="fc" id="L406">            adminTrips.add(adminTrip);</span>
<span class="fc" id="L407">        }</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">        if (!adminTrips.isEmpty()) {</span>
<span class="fc" id="L409">            return new Response&lt;&gt;(1, &quot;Travel Service Admin Query All Travel Success&quot;, adminTrips);</span>
        } else {
<span class="fc" id="L411">            return new Response&lt;&gt;(0, noCnontent, null);</span>
        }
    }

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>